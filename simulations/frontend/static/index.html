<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Streaming Demo</title>
    <style>
      :root {
        /* Refined monochrome dark palette (not pure black/white) */
        --bg: #0a0b0d;         /* page background (charcoal) */
        --panel: #111316;      /* raised surfaces */
        --border: #1d2129;     /* subtle borders */
        --text: #e8e9ec;       /* primary text (off-white) */
        --muted: #9ea3ab;      /* secondary text (cool gray) */
        --code: #0d0f12;       /* tiles / code-like blocks */
        /* Accents kept neutral for elegant B/W feel */
        --accent: #1f232a;     /* interactive bg (deep slate) */
        --accent-2: #2a2f38;   /* interactive border */
        --focus: #dfe2e6;      /* light gray focus border */
        --focusRing: rgba(223,226,230,.12); /* soft halo */
      }
      * { box-sizing: border-box; }
      body {
        margin: 0; padding: 0; background: var(--bg); color: var(--text);
        font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
        color-scheme: dark;
      }
      /* Make the main wrapper full-width with safe gutters */
      .wrap { max-width: none; margin: 0 auto; padding: 32px 16px; }
      @media (min-width: 1024px) { .wrap { padding: 32px 24px; } }
      .title { margin: 0 0 16px; font-weight: 650; letter-spacing: .2px; }
      .muted { color: var(--muted); margin: 0 0 20px; }

      /* Keep the form panel at a readable width */
      .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; max-width: 860px; margin: 0 auto; box-shadow: 0 0 0 1px rgba(255,255,255,.02) inset; }
      .row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; align-items: end; }
      @media (max-width: 900px) { .row { grid-template-columns: repeat(2, 1fr); } }
      @media (max-width: 520px) { .row { grid-template-columns: 1fr; } }
      .field { display:flex; flex-direction:column; gap:6px; }
      .field label { font-size: 12px; color: var(--muted); }
      input[type="text"], input[type="month"], select, textarea {
        width: 100%; border-radius: 10px; padding: 10px 12px; border: 1px solid var(--border);
        background: #0d0f12; color: var(--text); outline: none; transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
      }
      textarea { min-height: 44px; resize: vertical; }
      input:focus, select:focus, textarea:focus { border-color: var(--focus); box-shadow: 0 0 0 3px var(--focusRing); }
      button {
        appearance: none; border: 1px solid var(--accent-2);
        background: linear-gradient(180deg, #1a1d22, #15181d);
        color: var(--text); border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer;
        transition: transform .04s ease, filter .15s ease, background .15s ease, border-color .15s ease;
      }
      button:hover { filter: brightness(1.05); }
      button:active { transform: translateY(1px); }
      button[disabled] { opacity: .7; cursor: not-allowed; }
      .btn-ghost { background: transparent; border-color: var(--border); color: var(--muted); }
      .btn-ghost:hover { border-color: #343a44; color: var(--text); filter: none; }

      .output { margin-top: 16px; background: var(--code); border: 1px solid var(--border);
        border-radius: 10px; padding: 12px; max-height: 60vh; overflow: auto; box-shadow: 0 0 0 1px rgba(255,255,255,.02) inset; }
      .label { font-size: 13px; color: var(--muted); margin-bottom: 8px; }
      pre { margin: 0; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
      /* Comparison table layout */
      .scenarios { margin-top: 16px; }
      .comparison-table { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: 0 0 0 1px rgba(255,255,255,.02) inset; }
      .table-header { display: grid; grid-template-columns: repeat(4, 1fr); background: var(--accent); border-bottom: 1px solid var(--border); }
      .table-header .header-cell { padding: 16px 12px; text-align: center; font-weight: 700; font-size: 14px; color: var(--text); letter-spacing: .2px; border-right: 1px solid var(--border); }
      .table-header .header-cell:last-child { border-right: none; }
      .table-body { display: grid; grid-template-columns: repeat(4, 1fr); min-height: 400px; }
      .table-cell { padding: 16px 12px; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
      .table-cell:last-child { border-right: none; }
      
      /* Responsive design */
      @media (max-width: 1200px) { 
        .table-header { grid-template-columns: repeat(2, 1fr); }
        .table-body { grid-template-columns: repeat(2, 1fr); }
        .table-header .header-cell:nth-child(2), .table-cell:nth-child(2) { border-right: none; }
        .table-header .header-cell:nth-child(3), .table-cell:nth-child(3) { border-top: 1px solid var(--border); }
        .table-header .header-cell:nth-child(4), .table-cell:nth-child(4) { border-top: 1px solid var(--border); border-right: none; }
      }
      @media (max-width: 640px) { 
        .table-header { grid-template-columns: 1fr; }
        .table-body { grid-template-columns: 1fr; }
        .table-header .header-cell, .table-cell { border-right: none; border-bottom: 1px solid var(--border); }
        .table-header .header-cell:last-child, .table-cell:last-child { border-bottom: none; }
      }
      .cell-content { flex: 1; }
      .tile-output { margin: 0; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 13px; line-height: 1.4; max-height: 35vh; overflow: auto; display: none; }
      .timeline-area { flex: 1; }
      /* Timeline UI */
      .timeline { display: grid; gap: 12px; }
      .timeline-header { display:flex; align-items:center; justify-content:space-between; gap: 8px; }
      .tl-title { font-weight: 700; letter-spacing: .2px; color: var(--text); font-size: 15px; }
      .chips { display:flex; flex-wrap: wrap; gap: 6px; }
      /* Flip Budget/Timeframe chips to elegant white for contrast */
      .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e3e6ea; border-radius: 999px; color: #16181c; background: #ffffff; font-size: 13px; }
      .chip .val { font-weight: 700; font-size: 14px; color: #0b0d10; }
      .phases { display:grid; gap:10px; }
      /* Flip the phase card to white with dark text; keep inner task cards dark for contrast */
      .phase { border:1px solid #e3e6ea; border-radius: 10px; padding:10px; background: #ffffff; color: #16181c; }
      .phase-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
      .phase-name { font-weight: 600; color: #0f1216; }
      .phase-span { color: #3a4048; font-size: 12px; }
      .phase-summary { color: #2b3138; font-size: 13px; margin-bottom:6px; }
      .tasks { display:grid; grid-template-columns: 1fr; gap:8px; }
      .task { display:flex; align-items:flex-start; gap:8px; padding:8px; border:1px solid var(--border); border-radius:8px; background:#0f1216; }
      .dot { width:8px; height:8px; border-radius:50%; background:#cfd3d8; margin-top:6px; }
      .task-body { display:flex; flex-direction:column; gap:4px; }
      .task-title { font-weight:600; font-size:13px; color: var(--text); }
      .task-desc { font-size:12px; color: var(--muted); }
      .task-meta { display:flex; gap:6px; flex-wrap:wrap; }
      .meta { font-size:11px; color: var(--muted); border:1px solid var(--border); padding:2px 6px; border-radius:999px; }
      /* Timeline loader */
      .tl-loading { display:flex; align-items:center; gap:8px; color: var(--muted); font-size: 13px; }
      .tl-loading .bars i { height: 10px; }

      /* Loading animation for tiles */
      .tile.loading .tile-output { color: var(--muted); }
      .placeholder { display: inline-flex; align-items: center; gap: 8px; }
      .bars { display: inline-flex; gap: 3px; }
      .bars i { width: 3px; height: 12px; background: #2e333c; border-radius: 2px; animation: bounce 1s ease-in-out infinite; }
      .bars i:nth-child(2) { animation-delay: .1s; }
      .bars i:nth-child(3) { animation-delay: .2s; }
      .placeholder .msg { opacity: .9; }
      @keyframes bounce { 0%, 100% { transform: translateY(0); opacity: .6; } 50% { transform: translateY(-4px); opacity: 1; } }

      /* Global status badge */
      .status-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 999px; color: var(--muted); background: rgba(255,255,255,.02); font-size: 13px; }
      .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #7b828e; }
      .status-badge.streaming .status-dot { background: #d0d4d9; animation: pulse 1s ease-in-out infinite; }
      .status-badge.done .status-dot { background: #67e06b; box-shadow: 0 0 0 2px rgba(103,224,107,.15); }
      @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
  </head>
  <body>
    <main class="wrap">
      <h1 class="title">Simulations</h1>
      <p class="muted">Scenario simulations for best planning and budgeting.</p>

      <section class="panel">
        <form id="chat-form">
          <div class="row" style="margin-bottom:12px;">
            <div class="field">
              <label for="start_city">Start City</label>
              <input id="start_city" name="start_city" type="text" placeholder="San Francisco, CA, USA" />
            </div>
            <div class="field">
              <label for="destination_city">Destination City</label>
              <input id="destination_city" name="destination_city" type="text" placeholder="Lisbon, Portugal" />
            </div>
            <div class="field">
              <label for="budget_min">Min Budget (USD)</label>
              <input id="budget_min" name="budget_min" type="number" inputmode="numeric" min="0" step="100" placeholder="e.g., 25000" />
            </div>
            <div class="field">
              <label for="budget_max">Max Budget (USD)</label>
              <input id="budget_max" name="budget_max" type="number" inputmode="numeric" min="0" step="100" placeholder="e.g., 50000" />
            </div>
            <div class="field">
              <label for="move_month">Ideal Move Month</label>
              <input id="move_month" name="move_month" type="month" />
            </div>
            <div class="field" style="grid-column: 1 / -1;">
              <label for="context">Additional Context</label>
              <textarea id="context" name="context" rows="3" placeholder="e.g., family with dog, school priority, job details, constraints"></textarea>
            </div>
          </div>
          <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button type="button" id="clear-btn" class="btn-ghost">Clear</button>
            <button id="send-btn" type="submit">Run 4 Scenarios</button>
          </div>
        </form>
      </section>
      <!-- Comparison table spans the page width (with gutters) and isn't confined to the form width -->
      <section class="scenarios">
        <div id="status" class="status-badge" aria-live="polite"><span class="status-dot"></span><span class="status-text">Ready</span></div>
        <div id="comparison-table" class="comparison-table" style="display: none;">
          <div class="table-header">
            <div class="header-cell">Cheapest Options</div>
            <div class="header-cell">Fastest Options</div>
            <div class="header-cell">Balanced Options</div>
            <div class="header-cell">Luxury Options</div>
          </div>
          <div class="table-body" id="table-body"></div>
        </div>
      </section>
    </main>

    <script>
      const form = document.getElementById('chat-form');
      const btn = document.getElementById('send-btn');
      const clearBtn = document.getElementById('clear-btn');
      const startEl = document.getElementById('start_city');
      const destEl = document.getElementById('destination_city');
      const budgetMinEl = document.getElementById('budget_min');
      const budgetMaxEl = document.getElementById('budget_max');
      const monthEl = document.getElementById('move_month');
      const contextEl = document.getElementById('context');
      const comparisonTable = document.getElementById('comparison-table');
      const tableBody = document.getElementById('table-body');

      let controllers = [];
      let tableData = {};

      // Loading phrases for pre-stream animation
      const loadingPhrases = [
  'Analyzing the unique cultural fabric and social atmosphere of each district',
  'Aggregating and cross-referencing thousands of current rental market listings',
  'Simulating daily commute routes via public transit, driving, and cycling options',
  'Evaluating curriculum standards and admission availability at international schools',
  'Calculating a detailed, personalized cost of living index against your income',
  'Investigating and outlining the most viable long-term visa and residency pathways',
  'Scoring local coworking spaces based on amenities, community reviews, and pricing',
  'Correlating official crime statistics with hyperlocal resident safety sentiment data',
  'Pinpointing public parks, nature reserves, and recreational green spaces nearby',
  'Identifying popular and hidden-gem destinations for enriching weekend excursions',
  'Modeling the potential tax liabilities and fiscal implications of your relocation',
  'Assessing the quality, cost, and accessibility of local healthcare providers',
  'Projecting annual weather patterns, from seasonal averages to climate trends',
  'Mapping the entire culinary landscape, from street food stalls to fine dining',
  'Prioritizing and verifying the local availability of your essential lifestyle amenities',
  'Optimizing relocation scenarios to perfectly balance your timeline against your budget',
  'Compiling pet import regulations and identifying pet-friendly housing and areas',
  'Quantifying the distinct advantages and potential disadvantages between top neighborhoods',
  'Cataloging entertainment venues, cultural institutions, and local nightlife hotspots',
  'Forecasting the one-time overhead for utilities, security deposits, and initial setup',
  'Comparing local internet service providers based on speed, reliability, and real-world cost',
  'Uncovering often-overlooked administrative fees and potential hidden living expenses',
  'Generating a dynamic and comprehensive pre-move logistics and documentation checklist',
  'Forecasting your complete recurring monthly expenditures with high-fidelity projections',
  'Structuring a strategic, step-by-step itinerary for your first seven days post-arrival',
  'Deconstructing local banking requirements and international money transfer options',
  'Gauging the precise walkability and bikeability scores for shortlisted residential zones',
  'Parsing complex residency permit requirements and typical government processing timelines',
  'Identifying top-rated fitness centers, specialized gyms, and community sports clubs',
  'Assembling a comprehensive guide to navigating local public transportation networks',
  'Calibrating timezone differences and their practical impact on your work and social schedule',
  'Factoring in proximity and travel time to major airports and international hubs',
  'Synthesizing long-term data on air quality indexes and other environmental factors',
  'Researching important local customs, crucial social etiquette, and cultural nuances',
  'Benchmarking childcare facilities and early childhood education programs for quality',
  'Mapping the density of grocery stores, farmers markets, and specialty food shops',
  'Simulating the logistical challenges of shipping personal belongings and furniture',
  'Reviewing municipal services, including waste management and city recycling programs',
  'Analyzing the local job market for potential spousal or partner employment opportunities',
  'Collating information on language schools and effective immersion programs for learners',
  'Determining drivers license conversion processes and necessary vehicle import laws',
  'Evaluating the political stability and the long-term economic outlook of the region',
  'Pinpointing community centers and social groups that closely align with your hobbies',
  'Cross-validating cellular network coverage and comparing mobile data plan affordability',
  'Integrating critical consulate and embassy contact information for your nationality',
  'Projecting the financial impact of currency exchange rate fluctuations on your savings',
  'Assessing the availability and average cost of comprehensive renters insurance policies',
  'Sequencing the essential administrative tasks for a seamless and organized first month',
  'Investigating the local startup scene and key professional networking opportunities',
  'Building a final, hyper-personalized relocation feasibility and strategic action report'
];

      function attachAutoScroll(cell) {
        const out = cell.querySelector('.tile-output');
        cell._autoscroll = true; // follow output by default
        if (out) {
          out.addEventListener('scroll', () => {
            const distanceFromBottom = out.scrollHeight - out.scrollTop - out.clientHeight;
            cell._autoscroll = distanceFromBottom < 8; // re-enable when user returns to bottom
          });
        }
      }

      function randomPhrase() {
        return loadingPhrases[Math.floor(Math.random() * loadingPhrases.length)];
      }

      function setTileLoading(cell, on) {
        const timelineArea = cell.querySelector('.timeline-area');
        if (on) {
          cell.classList.add('loading');
          timelineArea.innerHTML = '<div class="placeholder"><span class="bars"><i></i><i></i><i></i></span><span class="msg"></span></div>';
          const msgEl = timelineArea.querySelector('.msg');
          msgEl.textContent = randomPhrase();
          // Rotate phrases with a randomized cadence per cell (< 1s)
          const schedule = () => {
            const delay = 350 + Math.random() * 400; // 350–750ms
            cell._loadingTimer = setTimeout(() => {
              if (msgEl && msgEl.parentElement) {
                msgEl.textContent = randomPhrase();
                schedule();
              }
            }, delay);
          };
          // Clear any previous timers just in case
          if (cell._loadingTimer) { clearTimeout(cell._loadingTimer); }
          if (cell._loadingInterval) { clearInterval(cell._loadingInterval); cell._loadingInterval = null; }
          schedule();
        } else {
          cell.classList.remove('loading');
          if (cell._loadingTimer) { clearTimeout(cell._loadingTimer); cell._loadingTimer = null; }
          if (cell._loadingInterval) { clearInterval(cell._loadingInterval); cell._loadingInterval = null; }
        }
      }

      function setStatus(state, text) {
        const el = document.getElementById('status');
        const txt = el.querySelector('.status-text');
        el.classList.remove('streaming','done');
        if (state) el.classList.add(state);
        if (typeof text === 'string') txt.textContent = text;
      }

      function createTableCell() {
        const cell = document.createElement('div');
        cell.className = 'table-cell';
        cell.innerHTML = `
          <div class="cell-content">
            <pre class="tile-output"></pre>
            <div class="timeline-area"></div>
          </div>
        `;
        return cell;
      }

      async function streamToCell(scenario, payload, cell, controller) {
        const out = cell.querySelector('.tile-output');
        const timelineArea = cell.querySelector('.timeline-area');
        out.textContent = '';
        setTileLoading(cell, true);
        try {
          const resp = await fetch('/api/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...payload, scenario }),
            signal: controller.signal,
          });
          if (!resp.ok || !resp.body) {
            setTileLoading(cell, false);
            out.textContent = `Error: ${resp.status} ${resp.statusText}`;
            return;
          }
          const reader = resp.body.getReader();
          const decoder = new TextDecoder();
          let received = false;
          let jsonBuffer = '';
          
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (!received) {
              received = true;
              setTileLoading(cell, false);
              out.textContent = '';
            }
            jsonBuffer += decoder.decode(value, { stream: true });
          }
          
          // Parse JSON and render timeline directly
          try {
            const data = JSON.parse(jsonBuffer);
            if (data.error) {
              timelineArea.innerHTML = `<div style="color: #d66; text-align: center; padding: 20px;">Error: ${data.error}</div>`;
            } else {
              // Store data and render timeline
              tableData[scenario] = data;
              renderTimeline(timelineArea, data);
            }
          } catch (parseErr) {
            timelineArea.innerHTML = `<div style="color: #d66; text-align: center; padding: 20px;">Failed to parse response: ${parseErr}</div>`;
          }
        } catch (err) {
          if (controller.signal.aborted) {
            timelineArea.innerHTML = '<div style="color: #9ea3ab; text-align: center; padding: 20px;">[aborted]</div>';
          } else {
            timelineArea.innerHTML = `<div style="color: #d66; text-align: center; padding: 20px;">[fetch error] ${err}</div>`;
          }
        }
        finally {
          setTileLoading(cell, false);
        }
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        // Abort any in-flight streams
        controllers.forEach(c => c.abort());
        controllers = [];
        tableData = {};
        
        // Stop any active loading animations from prior cells
        document.querySelectorAll('.table-cell').forEach(t => {
          if (t._loadingTimer) { clearTimeout(t._loadingTimer); t._loadingTimer = null; }
          if (t._loadingInterval) { clearInterval(t._loadingInterval); t._loadingInterval = null; }
        });
        
        // Clear and setup table
        tableBody.innerHTML = '';
        comparisonTable.style.display = 'block';

        // Build a flexible budget range string
        const minVal = budgetMinEl.value ? Number(budgetMinEl.value) : null;
        const maxVal = budgetMaxEl.value ? Number(budgetMaxEl.value) : null;
        let budgetRange = '';
        if (minVal != null && maxVal != null && isFinite(minVal) && isFinite(maxVal) && maxVal >= minVal) {
          budgetRange = `${formatUSD(minVal)} - ${formatUSD(maxVal)}`;
        } else if (minVal != null && isFinite(minVal)) {
          budgetRange = `Over ${formatUSD(minVal)}`;
        } else if (maxVal != null && isFinite(maxVal)) {
          budgetRange = `Under ${formatUSD(maxVal)}`;
        }

        const payload = {
          start_city: startEl.value.trim(),
          destination_city: destEl.value.trim(),
          budget_range: budgetRange,
          move_month: monthEl.value,
          context: contextEl.value.trim(),
        };
        btn.disabled = true; btn.textContent = 'Streaming…';
        setStatus('streaming', 'Streaming 4 scenarios…');
        let done = 0;

        const scenarios = [
          { key: 'cheapest', label: 'Cheapest Options' },
          { key: 'fastest', label: 'Fastest Options' },
          { key: 'balanced', label: 'Balanced Options' },
          { key: 'luxury', label: 'Luxury Options' },
        ];

        // Create table cells for each scenario
        scenarios.forEach(s => {
          const cell = createTableCell();
          cell.dataset.key = s.key;
          cell.dataset.label = s.label;
          tableBody.appendChild(cell);
          attachAutoScroll(cell);
        });

        // Start streaming for all scenarios in parallel
        for (let i = 0; i < scenarios.length; i++) {
          const s = scenarios[i];
          const cell = tableBody.children[i];
          const controller = new AbortController();
          controllers.push(controller);
          // Fire and forget; no await here to keep them parallel
          streamToCell(s.key, payload, cell, controller).finally(() => {
            done += 1;
            if (done === scenarios.length) {
              btn.disabled = false; btn.textContent = 'Run 4 Scenarios';
              setStatus('done', 'All scenarios complete');
            }
          });
        }
      });
      function formatUSD(n) {
        const num = Number(n);
        if (!isFinite(num)) return '';
        return num.toLocaleString(undefined, { maximumFractionDigits: 0 });
      }


      clearBtn.addEventListener('click', () => {
          startEl.value = '';
          destEl.value = '';
          budgetMinEl.value = '';
          budgetMaxEl.value = '';
          monthEl.value = '';
          contextEl.value = '';
        tableBody.innerHTML = '';
        comparisonTable.style.display = 'none';
        tableData = {};
        setStatus('', 'Ready');
      });


      function renderTimeline(container, tl) {
        const fmtMoney = (n) => (typeof n === 'number' && isFinite(n)) ? `$${n.toLocaleString()}` : null;
        const fmtMonths = (n) => (typeof n === 'number' && isFinite(n)) ? `${n} mo` : null;

        // Compact header with key metrics
        const money = fmtMoney(tl.budget_total_usd);
        const months = fmtMonths(tl.timeframe_months);
        const score = typeof tl.feasibility_score === 'number' ? `${tl.feasibility_score}/10` : null;
        
        const metricsHtml = `
          <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px; padding:10px; background:var(--accent); border-radius:8px;">
            ${money ? `<div style="display:flex; justify-content:space-between; font-size:13px;"><span style="color:var(--muted);">Budget:</span><span style="font-weight:600;">${money}</span></div>` : ''}
            ${months ? `<div style="display:flex; justify-content:space-between; font-size:13px;"><span style="color:var(--muted);">Timeline:</span><span style="font-weight:600;">${months}</span></div>` : ''}
            ${score ? `<div style="display:flex; justify-content:space-between; font-size:13px;"><span style="color:var(--muted);">Score:</span><span style="font-weight:600;">${score}</span></div>` : ''}
          </div>
        `;

        const phases = Array.isArray(tl.phases) ? tl.phases.slice(0, 3) : []; // Limit to first 3 phases for space
        const phasesHtml = phases.map(ph => {
          const span = (ph.start_month != null || ph.end_month != null)
            ? `<span style="color:var(--muted); font-size:11px;">${ph.start_month ?? 0}–${ph.end_month ?? ''} mo</span>`
            : '';
          const tasks = Array.isArray(ph.tasks) ? ph.tasks.slice(0, 3) : []; // Limit tasks for space
          const tasksHtml = tasks.map(t => {
            const cost = typeof t.cost_usd === 'number' ? fmtMoney(t.cost_usd) : null;
            const duration = typeof t.duration_weeks === 'number' ? `${t.duration_weeks}w` : null;
            const meta = [cost, duration].filter(Boolean).join(' • ');
            return `
              <div style="display:flex; gap:6px; margin:4px 0; font-size:12px;">
                <div style="width:6px; height:6px; border-radius:50%; background:${t.milestone ? '#67e06b' : '#9ea3ab'}; margin-top:6px; flex-shrink:0;"></div>
                <div style="flex:1;">
                  <div style="font-weight:500; line-height:1.3;">${escapeHtml(t.title || '')}</div>
                  ${meta ? `<div style="color:var(--muted); font-size:10px; margin-top:2px;">${meta}</div>` : ''}
                </div>
              </div>`;
          }).join('');
          return `
            <div style="margin-bottom:12px; padding:8px; border:1px solid var(--border); border-radius:6px; background:rgba(255,255,255,0.02);">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                <div style="font-weight:600; font-size:13px;">${escapeHtml(ph.name || '')}</div>
                ${span}
              </div>
              ${tasksHtml}
            </div>`;
        }).join('');

        // Compact pros/cons
        let prosConsHtml = '';
        if ((Array.isArray(tl.pros) && tl.pros.length) || (Array.isArray(tl.cons) && tl.cons.length)) {
          const pros = Array.isArray(tl.pros) ? tl.pros.slice(0, 2) : []; // Limit to 2 each
          const cons = Array.isArray(tl.cons) ? tl.cons.slice(0, 2) : [];
          const prosHtml = pros.map(p => `<div style="font-size:11px; color:#67e06b; margin:2px 0;">✓ ${escapeHtml(p)}</div>`).join('');
          const consHtml = cons.map(c => `<div style="font-size:11px; color:#d66; margin:2px 0;">✗ ${escapeHtml(c)}</div>`).join('');
          prosConsHtml = `
            <div style="margin-top:8px; padding-top:8px; border-top:1px dashed var(--border);">
              ${prosHtml}${consHtml}
            </div>
          `;
        }

        container.innerHTML = `<div>${metricsHtml}${phasesHtml}${prosConsHtml}</div>`;
      }

      function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
      }
    </script>
  </body>
  </html>
